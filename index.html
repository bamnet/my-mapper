<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>GeoJSON Viewer</title>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <script type="text/javascript">
    var developerKey = '<key>';
    var clientId = '<something>.apps.googleusercontent.com';
    var scope = ['https://www.googleapis.com/auth/drive.readonly'];

    var map;

    function loadMapApi() {
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&callback=onMapApiLoad';
      document.body.appendChild(script);
    }

    function onApiLoad() {
      gapi.load('auth', {'callback': onAuthApiLoad});
      gapi.load('picker');
    }

    function onClientLoad() {
      gapi.client.load('drive', 'v2');
    }

    function onAuthApiLoad() {
      gapi.auth.authorize({
        'client_id': clientId,
        'scope': scope,
        'immediate': false
      }, handleAuthResult);
    }

    function onMapApiLoad(){
      var mapOptions = {
        zoom: 4,
        center: new google.maps.LatLng(-34.397, 150.644)
      };
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
    }

    function handleAuthResult(authResult){
      if (authResult && !authResult.error){
        createPicker();
      }
    }

    function createPicker() {
      var view = new google.picker.View(google.picker.ViewId.DOCS);
      var mimeTypes = [
        'application/json','application/x-javascript','text/javascript',
        'text/x-javascript','text/x-json','application/octet-stream'
      ];
      view.setMimeTypes(mimeTypes.join(','));
      var picker = new google.picker.PickerBuilder()
          .setAppId(clientId)
          .setOAuthToken(gapi.auth.getToken().access_token)
          .addView(view)
          .addView(new google.picker.DocsUploadView())
          .setDeveloperKey(developerKey)
          .setCallback(pickerCallback)
          .build();
       picker.setVisible(true);
    }

    // A simple callback implementation.
    function pickerCallback(data) {
      if (data.action == google.picker.Action.PICKED) {
        loadMapApi();
        var fileId = data.docs[0].id;
        loadFile(fileId);
      }
    }
    function loadFile(fileID){
      var request = gapi.client.drive.files.get({
        'fileId': fileID
      });
      request.execute(function(file) {
        if (file.downloadUrl) {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', file.downloadUrl);
          xhr.setRequestHeader('Authorization', 'Bearer ' + gapi.auth.getToken().access_token);
          xhr.onload = function() {
            var dataStr = xhr.responseText;
            try {
              var data = JSON.parse(dataStr);
              mapData(data);
            } catch (e) {
              alert("Unable to parse data, doesn't look like JSON.", e);
            }
          };
          xhr.onerror = function() {
            alert("Error opening file from Google Drive")
          };
          xhr.send();
        }
      });
    }

    function mapData(data){
      try {
        map.data.addGeoJson(data);
      } catch (e) {
        alert("Unable to map JSON, might not be GeoJSON?", e);
      }
    }
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <script type="text/javascript" src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
    <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=onClientLoad"></script>
  </body>
</html>
